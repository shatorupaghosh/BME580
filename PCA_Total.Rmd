---
title: "PCA Full Data"
author: "Sophia Leeman"
date: "2023-04-04"
output: html_document
---

```{r}
library(factoextra)
library(tidyverse)
library(corrplot)
```

```{r}
df_f <- read.csv("TrainTestDatasets/Train_CaseFatality.csv")
df_i <- read.csv("TrainTestDatasets/Train_Incident.csv")

df_f <- subset(df_f, select = -c(Case_Fatality_Ratio, Incident_Rate, Confirmed, Deaths, Total_Test_Results, Testing_Rate, State, Month, Year))
df_i <- subset(df_i, select = -c(Case_Fatality_Ratio, Incident_Rate, Confirmed, Deaths, Total_Test_Results, Testing_Rate, State, Month, Year))
```

```{r}
numeric_cols_f <- sapply(df_f, is.numeric)
pca_f <- prcomp(df_f[numeric_cols_f])
pca_f

numeric_cols_i <- sapply(df_i, is.numeric)
pca_i <- prcomp(df_i[numeric_cols_i])
pca_i
```

```{r}
graph_f <- fviz_eig(pca_f, addlabels = T) 
graph_f
graph_i <- fviz_eig(pca_i, addlabels = T) 
graph_i
```
I would chose to use 6 dimensions by analysis of the location of the elbow in the graph.
```{r}
varPercent_f <- pca_f$sdev^2/sum(pca_f$sdev^2)*100
cumVar_f <- sum(varPercent_f[1:6])
cumVar_f

varPercent_i <- pca_i$sdev^2/sum(pca_i$sdev^2)*100
cumVar_i <- sum(varPercent_i[1:6])
cumVar_i
```
This accounts for about 88% of the variance.

```{r}
loadings_f <- pca_f$rotation
loadings_f <- as.data.frame(loadings_f[,1:4])
loadings_f  %>% arrange(desc(.312*abs(PC1)+.176*abs(PC2)+.126*abs(PC3)+.08*abs(PC4)))

loadings_i <- pca_i$rotation
loadings_i <- as.data.frame(loadings_i[,1:4])
loadings_i  %>% arrange(desc(.312*abs(PC1)+.176*abs(PC2)+.126*abs(PC3)+.08*abs(PC4)))

```

```{r}
fviz_pca_ind(pca_f,
             col.ind = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     
             )

fviz_pca_ind(pca_i,
             col.ind = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     
             )
```

Visualize dimensions
```{r, fig.align = "center", fig.height = 4, fig.width = 4 ,out.width = "4in"}
fviz_pca_biplot(pca_f, col.var = "contrib", repel = TRUE) 
fviz_pca_biplot(pca_i, col.var = "contrib", repel = TRUE) 
```

```{r, fig.align = "center", fig.height = 4, fig.width = 4,out.width = "4in"}
fviz_pca_var(pca_f,
             col.var = "contrib", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE   
             )
fviz_pca_var(pca_i,
             col.var = "contrib", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE   
             )
```

```{r, fig.align = "center", fig.height = 4, fig.width = 4 ,out.width = "4in"}
fviz_pca_var(pca_f, col.var = "contrib", repel = TRUE) 
fviz_pca_var(pca_i, col.var = "contrib", repel = TRUE)
```

"PC 1 is significant and accounts for 28.1% (95%-CI:27.4-28.8) of the total variation PC 2 is significant and accounts for 20.5% (95%-CI:20-21) of the total variation PC 3 is significant and accounts for 15.1% (95%-CI:14.6-15.8) of the total variation  The first 3 PC axes are significant and account for 63.7% of the total variation  Variables 2, 3, and 4 have significant loadings on PC 1 Variables 1, and 6 have significant loadings on PC 2 Variables , and 5 have significant loadings on PC 3"

"PC 1 is significant and accounts for 28% (95%-CI:27.3-28.9) of the total variation PC 2 is significant and accounts for 20.6% (95%-CI:20-21.2) of the total variation PC 3 is significant and accounts for 15.4% (95%-CI:14.7-16.1) of the total variation  The first 3 PC axes are significant and account for 63.9% of the total variation  Variables 2, 3, and 4 have significant loadings on PC 1 Variables 1, and 6 have significant loadings on PC 2 Variables , and 5 have significant loadings on PC 3"
```{r}
library(PCAtest)

output <- capture.output({
PCAtest(df_f[numeric_cols_f], 100, 100, 0.05, varcorr=FALSE, counter=FALSE, plot=TRUE)
})
cat(output, file = "significance_PCA_f.txt")

output2 <- capture.output({
PCAtest(df_i[numeric_cols_i], 100, 100, 0.05, varcorr=FALSE, counter=FALSE, plot=TRUE)
})
cat(output2, file = "significance_PCA_i.txt")
```
```{r}
df_f <- read.csv("TrainTestDatasets/Train_CaseFatality.csv")
df_i <- read.csv("TrainTestDatasets/Train_Incident.csv")

df_f <- cbind(df_f, pca_f$x[,1:3])

df_i <- cbind(df_i, pca_i$x[,1:3])

write.csv(df_f, "TrainTestDatasets/Train_CaseFatality_PCA.csv", row.names=FALSE)
write.csv(df_i, "TrainTestDatasets/Train_Incident_PCA.csv", row.names=FALSE)


```

